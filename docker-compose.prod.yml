version: '3'                                                                                                                                                                                                   
services:                                                                                                                                                                                                      
  traefik:                                                                                                                                                                                                   
    image: traefik:v3.0                                                                                                                                                                                    
    ports:                                                                                                                                                                                                 
      - "80:80"                                                                                                                                                                                          
      - "443:443"                                                                                                                                                                                        
      - "8883:8883"                                                                                                                                                                                      
      - "9001:9001"                                                                                                                                                                                      
    volumes:                                                                                                                                                                                               
      - "./traefik:/etc/traefik" # static and dynamic config in this folder                                                                                                                              
      - "./letsencrypt:/letsencrypt"                                                                                                                                                                     
      - "/var/run/docker.sock:/var/run/docker.sock:ro"                                                                                                                                                   
    labels:                                                                                                                                                                                                
      - "traefik.enable=true"                                                                                                                                                                            
      - "traefik.http.routers.dashboard.entrypoints=websecure"                                                                                                                                           
      - "traefik.http.routers.dashboard.rule=Host(`traefik.inditan.com`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"                                                                            
      - "traefik.http.routers.dashboard.service=api@internal"                                                                                                                                            
      - "traefik.http.routers.dashboard.tls.certresolver=myresolver"                                                                                                                                     
                                                                                                                                                                                                            
  api:                                                                                                                                                                                                       
    volumes:                                                                                                                                                                                               
      - static:/code/static                                                                                                                                                                              
    env_file: .env                                                                                                                                                                                         
    labels:                                                                                                                                                                                                
      - "traefik.enable=true"                                                                                                                                                                            
      - "traefik.http.routers.api-secure.entrypoints=websecure"                                                                                                                                          
      - "traefik.http.routers.api-secure.rule=Host(`inditan.com`) && PathPrefix(`/api/v1/`)"                                                                                                             
      - "traefik.http.routers.api-secure.tls.certresolver=myresolver"                                                                                                                                    
    deploy:                                                                                                                                                                                                
      mode: replicated                                                                                                                                                                                   
      replicas: 3                                                                                                                                                                                        
                                                                                                                                                                                                            
  worker:                                                                                                                                                                                                    
    env_file: .env                                                                                                                                                                                         
    restart: always                                                                                                                                                                                        
    deploy:                                                                                                                                                                                                
      mode: replicated                                                                                                                                                                                   
      replicas: 3  