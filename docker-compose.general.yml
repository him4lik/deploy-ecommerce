version: '3'                                                                                                                                                                                                   
services:                                                                                                                                                                                                      
  traefik:                                                                                                                                                                                                   
    image: traefik:v3.0                                                                                                                                                                                    
    ports:                                                                                                                                                                                                 
      - "80:80"                                                                                                                                                                                          
      - "443:443"                                                                                                                                                                                        
      - "5671:5671"                                                                                                                                                                                      
      - "5672:5672"                                                                                                                                                                                      
      - "8883:8883"                                                                                                                                                                                      
      - "9001:9001"                                                                                                                                                                                      
    volumes:                                                                                                                                                                                               
      - "./traefik:/etc/traefik" # static and dynamic config in this folder                                                                                                                              
      - "./letsencrypt:/letsencrypt"                                                                                                                                                                     
      - "/var/run/docker.sock:/var/run/docker.sock:ro"                                                                                                                                                   
    labels:                                                                                                                                                                                                
      - "traefik.enable=true"                                                                                                                                                                            
      - "traefik.http.routers.dashboard.entrypoints=websecure"                                                                                                                                           
      - "traefik.http.routers.dashboard.rule=Host(`traefik.inditan.com`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"                                                                            
      - "traefik.http.routers.dashboard.service=api@internal"                                                                                                                                            
      - "traefik.http.routers.dashboard.tls.certresolver=myresolver"                                                                                                                                     
    networks:                                                                                                                                                                                              
      - inditan_prod                                                                                                                                                                                        
    deploy:                                                                                                                                                                                                
      mode: replicated                                                                                                                                                                                   
      replicas: 1                                                                                                                                                                                        
      resources:                                                                                                                                                                                         
        limits:                                                                                                                                                                                        
          memory: 2G

  website:                                                                                                                                                                                                   
    image: deploy-website                                                                                                                                                                                  
    labels:                                                                                                                                                                                                
        - "traefik.enable=true"                                                                                                                                                                            
        - "traefik.http.routers.website.entrypoints=web"                                                                                                                                                   
        - "traefik.http.routers.website.middlewares=redirect-to-https@file"                                                                                                                                
        - "traefik.http.routers.website.middlewares=security-headers@file"                                                                                                                                 
        - "traefik.http.routers.website.rule=Host(`inditan.com`)"                                                                                                                                          
        - "traefik.http.routers.website-secure.entrypoints=websecure"                                                                                                                                      
        - "traefik.http.routers.website-secure.rule=Host(`inditan.com`)"                                                                                                                                   
        - "traefik.http.routers.website-secure.tls.certresolver=myresolver"                                                                                                                                
        - "traefik.http.routers.website-secure.middlewares=security-headers@file"                                                                                                                          
    networks:                                                                                                                                                                                              
        - inditan_prod                                                                                                                                                                                        
    deploy:                                                                                                                                                                                                
        mode: replicated                                                                                                                                                                                   
        replicas: 1                                                                                                                                                                                        
        resources:                                                                                                                                                                                         
            limits:                                                                                                                                                                                        
                memory: 2G

networks:                                                                                                                                                                                                      
  inditan_prod:                                                                                                                                                                                                 
    external: true                                                                                                                                                                                         
    driver: overlay